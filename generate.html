<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<title>Generate</title>
	<meta name="viewport" content="width=device-width,initial-scale=1">

	<script type="module">
		const body = document.createElement('div');

		body.style.fontFamily = "'Courier New', monospace";

		const generateButton = document.createElement('button');
		generateButton.appendChild(document.createTextNode("Generate"));
		generateButton.style.top = '8px';
		generateButton.style.right = '8px';
		generateButton.style.position = 'absolute';
		generateButton.style.height = '32px';

		let worker = null;
		const process = () => {
			if (worker) {
				worker.terminate();
				worker = null;
			} else {
				const setMessage = (message) => {
					while (body.firstChild) body.removeChild(body.lastChild);
					for (const line of message) {
						const stat = document.createElement('div');
						stat.appendChild(document.createTextNode(line));
						body.appendChild(stat);
					}
				};

				const sendData = (data, dbphistomefel = false) => {
					let url = 'https://snovakow.dev/snovakow/import.php?version=1';
					url += '&puzzleClues=' + data.puzzleClues;
					url += '&puzzleFilled=' + data.puzzleFilled;
					url += '&clueCount=' + data.clueCount;
					url += '&simple=' + data.simple;
					url += '&naked2=' + data.naked2;
					url += '&naked3=' + data.naked3;
					url += '&naked4=' + data.naked4;
					url += '&hidden2=' + data.hidden2;
					url += '&hidden3=' + data.hidden3;
					url += '&hidden4=' + data.hidden4;
					url += '&yWing=' + data.yWing;
					url += '&xyzWing=' + data.xyzWing;
					url += '&xWing=' + data.xWing;
					url += '&swordfish=' + data.swordfish;
					url += '&jellyfish=' + data.jellyfish;
					url += '&uniqueRectangle=' + data.uniqueRectangle;
					url += '&phistomefel=' + data.phistomefel;
					url += '&superpositions=' + data.superpositions;
					url += '&bruteForce=' + data.bruteForce;
					if (dbphistomefel) url += '&dbphistomefel';

					fetch(url, {
						method: "GET" // default, so we can ignore
					});
				};

				const workerData = { search: window.location.search };
				const prop = "?grid=";
				if (window.location.search.startsWith(prop) && window.location.search.length === prop.length + 81) {
					workerData.grid = window.location.search.substring(prop.length);
				}

				worker = new Worker("worker.js", { type: "module" });
				worker.postMessage(workerData);
				worker.onmessage = (e) => {
					const data = e.data;
					if (data.message) setMessage(data.message);
					if (window.location.search === "?db") sendData(data);
					if (window.location.search === "?dbphistomefel") sendData(data, true);
				};
			}
		};

		generateButton.addEventListener('click', () => {
			process();
		});
		document.body.appendChild(generateButton);

		document.body.appendChild(body);
	</script>

</head>

<body></body>

</html>