<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<title>Generate</title>
	<meta name="viewport" content="width=device-width,initial-scale=1">

	<script type="module">
		const body = document.createElement('div');

		body.style.fontFamily = "'Courier New', monospace";

		const generateButton = document.createElement('button');
		generateButton.appendChild(document.createTextNode("Generate"));
		generateButton.style.top = '8px';
		generateButton.style.right = '8px';
		generateButton.style.position = 'absolute';
		generateButton.style.height = '32px';

		const updateButton = document.createElement('button');
		updateButton.appendChild(document.createTextNode("Update"));
		updateButton.style.top = '48px';
		updateButton.style.right = '8px';
		updateButton.style.position = 'absolute';
		updateButton.style.height = '32px';

		const setMessage = (message) => {
			while (body.firstChild) body.removeChild(body.lastChild);
			for (const line of message) {
				const stat = document.createElement('div');
				stat.appendChild(document.createTextNode(line));
				body.appendChild(stat);
			}
		};

		const searchParams = new URLSearchParams(window.location.search);

		const table = searchParams.get("table");

		const sentDisplay = document.createElement('span');
		sentDisplay.style.position = 'absolute';
		sentDisplay.style.top = '88px';
		sentDisplay.style.right = '8px';
		sentDisplay.style.fontFamily = 'Courier New';
		sentDisplay.style.visibility = 'hidden';
		sentDisplay.textContent = "0 Sent";
		document.body.appendChild(sentDisplay);

		let totalSent = 0;
		const readyData = [];
		const sendData = (data) => {
			if (!table) return;

			let url = 'https://snovakow.dev/sudokulib/import.php?version=1';
			url += '&puzzleClues=' + data.puzzleClues;
			url += '&puzzleFilled=' + data.puzzleFilled;
			url += '&clueCount=' + data.clueCount;
			url += '&simple=' + data.simple;
			url += '&naked2=' + data.naked2;
			url += '&naked3=' + data.naked3;
			url += '&naked4=' + data.naked4;
			url += '&hidden2=' + data.hidden2;
			url += '&hidden3=' + data.hidden3;
			url += '&hidden4=' + data.hidden4;
			url += '&omissions=' + data.omissions;
			url += '&yWing=' + data.yWing;
			url += '&xyzWing=' + data.xyzWing;
			url += '&xWing=' + data.xWing;
			url += '&swordfish=' + data.swordfish;
			url += '&jellyfish=' + data.jellyfish;
			url += '&uniqueRectangle=' + data.uniqueRectangle;
			url += '&phistomefel=' + data.phistomefel;
			url += '&superpositions=' + data.superpositions;
			url += '&bruteForce=' + data.bruteForce;
			url += '&table=' + table;

			fetch(url, { method: "GET" /* default, so we can ignore */ });
		};

		let readyDataSending = false;
		const maxSend = 1000;
		const updateData = (data) => {
			if (data) readyData.push(data);
			if (readyDataSending) return;
			readyDataSending = true;

			const table = searchParams.get("table");
			if (!table) return;

			const url = 'https://snovakow.dev/sudokulib/update.php?version=1&table=' + table;

			const readyDataSend = [];
			let readyDataSent = 0;
			for (const ready of readyData) {
				const post = {
					version: 1,
					id: ready.id,
					simple: ready.simple,
					naked2: ready.naked2,
					naked3: ready.naked3,
					naked4: ready.naked4,
					hidden2: ready.hidden2,
					hidden3: ready.hidden3,
					hidden4: ready.hidden4,
					omissions: ready.omissions,
					yWing: ready.yWing,
					xyzWing: ready.xyzWing,
					xWing: ready.xWing,
					swordfish: ready.swordfish,
					jellyfish: ready.jellyfish,
					uniqueRectangle: ready.uniqueRectangle,
					phistomefel: ready.phistomefel,
					superpositions: ready.superpositions,
					bruteForce: ready.bruteForce
				};
				readyDataSend.push(ready);
				if (readyDataSend.length === maxSend) break;
			}
			readyData.splice(0, readyDataSend.length);

			const response = fetch(url, {
				method: "POST",
				body: JSON.stringify(readyDataSend),
			}).then(response => {
				readyDataSending = false;
				if (readyData.length > 0) updateData();
				// response.text().then(
				// 	(string)=>{
				// 		console.log(string);
				// 	}
				// );
			});

			totalSent += readyDataSend.length;
			sentDisplay.textContent = totalSent + " Sent";
		};

		let worker = null;
		const processGenerate = (grids) => {
			const workerData = { search: window.location.search };
			workerData.run = true;
			const grid = searchParams.get("grid");
			if (grid && grid.length === 81) {
				workerData.grid = grid;
			}
			workerData.grids = grids;

			worker.onmessage = (e) => {
				const data = e.data;
				if (data.message) setMessage(data.message);
				sendData(data);
			};

			worker.postMessage(workerData);
		};

		const processUpdate = () => {
			sentDisplay.style.visibility = 'visible';

			const inc = 10000;
			const end = 10000000;
			let start = 0;

			let sentCount = 0;
			const sentData = [];

			worker.onmessage = (e) => {
				const data = e.data;
				if (data.message) setMessage(data.message);
				updateData(data);
			};

			const sendRequest = () => {
				const xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = () => {
					// if (xhttp.readyState == 3) fillContent(xhttp.responseText, '... ' + diffTime());
					if (xhttp.readyState == 4 && xhttp.status == 200) {
						if (!worker) return;

						const options = {
							weekday: "long",
							year: "numeric",
							month: "long",
							day: "numeric",
							hour: "numeric",
							minute: "numeric",
							second: "numeric",
						};
						const json = JSON.parse(xhttp.responseText);
						// fillContent(json.length, time);

						start += inc;
						if (start < end) sendRequest();

						const workerData = { search: window.location.search };
						workerData.run = true;
						workerData.grids = json;
						worker.postMessage(workerData);
					}
				};
				const url = `https://snovakow.dev/sudokulib/feedSudoku.php?start=${start}&end=${start + inc}&table=${table}`;
				xhttp.open("GET", url, true);
				xhttp.send();
			}
			sendRequest();
		};

		const toggleWorker = () => {
			if (worker) {
				worker.terminate();
				worker = null;
				return;
			}
			worker = new Worker("worker.js", { type: "module" });
		};
		generateButton.addEventListener('click', () => {
			toggleWorker();
			if (worker) processGenerate();
		});

		updateButton.addEventListener('click', () => {
			toggleWorker();
			if (worker) processUpdate();
		});

		document.body.appendChild(generateButton);
		document.body.appendChild(updateButton);

		document.body.appendChild(body);
	</script>

</head>

<body></body>

</html>