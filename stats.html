<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<title>Stats</title>
	<meta name="viewport" content="width=device-width,initial-scale=1">
</head>

<body style="font-family: 'Courier New', monospace;">
	<script type="module">
		const container = document.createElement('div');
		container.style.fontFamily = "'Courier New', monospace";
		container.style.position = "absolute";
		container.style.top = "8px";
		container.style.left = "8px";
		document.body.appendChild(container);

		const searchParams = new URLSearchParams(window.location.search);
		const mode = searchParams.get("mode");

		const options = {
			weekday: "long",
			year: "numeric",
			month: "long",
			day: "numeric",
			hour: "numeric",
			minute: "numeric",
			second: "numeric",
		};

		const refresh = (search) => {
			const xhttp = new XMLHttpRequest();
			const startTime = performance.now();
			const diffTime = (fixed = 1) => {
				const diff = performance.now() - startTime;
				const res = Math.pow(10, fixed);
				const elapsed = Math.round(diff * res / 1000) / res;
				return elapsed.toFixed(fixed) + "s";
			};

			let timer = window.setInterval(() => {
				container.innerHTML = diffTime();
			}, 1000 / 30);
			const fillContent = (content, append) => {
				if (timer) {
					window.clearInterval(timer);
					timer = 0;
				}
				container.innerHTML = content + append;
			};
			xhttp.onreadystatechange = () => {
				if (xhttp.readyState == 3) fillContent(xhttp.responseText, '... ' + diffTime());
				if (xhttp.readyState == 4 && xhttp.status == 200) {
					const time = diffTime() + " " + new Date().toLocaleString(undefined, options);
					fillContent(xhttp.responseText, time);
				}
			};
			const url = "https://snovakow.dev/sudokulib/feed.php" + search;
			xhttp.open("GET", url, true);
			xhttp.send();
		};

		if (mode === "0" || mode === "2") {
			const tables = [];
			const tableSizes = new Map();

			const populate = () => {
				const content = [];
				for (const table of tables) {
					const count = tableSizes.get(table);
					content.push(table + ': ' + count.toLocaleString());
				}
				content.push('');
				content.push(new Date().toLocaleString(undefined, options));

				container.innerHTML = content.join('<br/>');
			};
			const setTableSize = (table, size) => {
				const count = tableSizes.get(table);
				if (count === undefined) {
					tables.push(table);
				}
				if (count === undefined || size > count) {
					tableSizes.set(table, size);
				}
			};

			if (mode === "0") {
				window.addEventListener("storage", (event) => {
					const int = parseInt(event.newValue);
					const nan = isNaN(int);
					if (nan) return;
					setTableSize(event.key, int);
					populate();
				});
			}

			let tablesIndex = 1;
			const tablesFind = () => {
				const xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = () => {
					if (xhttp.readyState != 4 || xhttp.status != 200) return;
					if (xhttp.responseText.length > 0) {
						const result = xhttp.responseText.split("=");
						if (result.length === 2) {
							const count = parseInt(result[1]);
							const nan = isNaN(count);
							if (!nan) {
								const name = result[0];
								setTableSize(name, count);
								if (count >= 10000000) {
									tablesIndex++;
									tablesFind();
									return;
								}
							}
						}
					}
					if (mode === "0") populate();
					if (mode === "2") refresh("?mode=2&table=" + tables.join(","));
				};
				const url = "https://snovakow.dev/sudokulib/feed.php?mode=0&table=puzzles" + tablesIndex;
				xhttp.open("GET", url, true);
				xhttp.send();
			};
			tablesFind();
		} else if (mode === "1") {
			refresh(window.location.search);
		}

	</script>
</body>

</html>