<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<title>Stats</title>
	<meta name="viewport" content="width=device-width,initial-scale=1">
</head>

<body style="font-family: 'Courier New', monospace;">
	<script type="module">
		const container = document.createElement('div');
		container.style.fontFamily = "'Courier New', monospace";
		container.style.position = "absolute";
		container.style.top = "8px";
		container.style.left = "8px";
		document.body.appendChild(container);

		const searchParams = new URLSearchParams(window.location.search);
		const mode = searchParams.get("mode");

		const options = {
			weekday: "long",
			year: "numeric",
			month: "long",
			day: "numeric",
			hour: "numeric",
			minute: "numeric",
			second: "numeric",
		};

		const sendLoop = () => {
			const xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = () => {
				if (xhttp.readyState != 4 || xhttp.status != 200) return;
				const time = new Date().toLocaleString(undefined, options);
				container.innerHTML = xhttp.responseText + time;

				window.setTimeout(() => { sendLoop(); }, 1000 * 1);
			};
			const url = "https://snovakow.dev/sudokulib/feed.php" + window.location.search;
			xhttp.open("GET", url, true);
			xhttp.send();
		};

		const refresh = () => {
			const xhttp = new XMLHttpRequest();
			const startTime = performance.now();
			const diffTime = (fixed = 1) => {
				const diff = performance.now() - startTime;
				const res = Math.pow(10, fixed);
				const elapsed = Math.round(diff * res / 1000) / res;
				return elapsed.toFixed(fixed) + "s";
			};

			let timer = window.setInterval(() => {
				container.innerHTML = diffTime();
			}, 1000 / 30);
			const fillContent = (content, append) => {
				if (timer) {
					window.clearInterval(timer);
					timer = 0;
				}
				container.innerHTML = content + append;
			};
			xhttp.onreadystatechange = () => {
				if (xhttp.readyState == 3) fillContent(xhttp.responseText, '... ' + diffTime());
				if (xhttp.readyState == 4 && xhttp.status == 200) {
					const time = diffTime() + " " + new Date().toLocaleString(undefined, options);
					fillContent(xhttp.responseText, time);
				}
			};
			const url = "https://snovakow.dev/sudokulib/feed.php" + window.location.search;
			xhttp.open("GET", url, true);
			xhttp.send();
		};

		if (mode === "0") sendLoop();
		else refresh();

	</script>
</body>

</html>